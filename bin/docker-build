#!/usr/bin/env bash
set -x # echo on

# Usage
#
# @example
#   bin/docker-build
#   bin/docker-build mysql
#   bin/docker-build sqlserver
#
# @example Tag the build
#   bin/docker-build --tag
#
# @example Push the build to docker repository
#   bin/docker-build --push
#
# @example tag and push
#   bin/docker-build --tag --push

IMAGE=${IMAGE:-"unknown"}
BRANCH=${BRANCH:-"$(git rev-parse --abbrev-ref HEAD | tr / -)"}
VERSION=${VERSION:-"$(date +%Y%m%d%H%M%S)"}

# build
docker build \
  -t $IMAGE \
  --build-arg DB=${1:-mysql} \
  .

# tag
if [[ $@ =~ '--tag' ]]; then
  docker tag $IMAGE $IMAGE:$BRANCH
  docker tag $IMAGE $IMAGE:$BRANCH-$VERSION
fi

# push
if [[ $@ =~ '--push' ]]; then
  docker push $IMAGE:${BRANCH}
  docker push $IMAGE:${BRANCH}-$VERSION
fi
